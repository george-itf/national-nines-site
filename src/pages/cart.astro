---
import BaseLayout from '../layouts/BaseLayout.astro';
const baseUrl = import.meta.env.BASE_URL || '/';
---

<BaseLayout title="Cart" description="Your shopping cart - National Nines Golf">
  <section class="py-12 bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-10">
        <h1 class="font-heading text-5xl font-bold text-brand-black mb-4">Your Cart</h1>
        <div class="w-20 h-1 bg-brand-red mx-auto"></div>
      </div>
      
      <!-- Empty Cart State -->
      <div id="empty-cart" class="text-center py-12">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <p class="text-gray-500 text-lg mb-6">Your cart is empty</p>
        <a href={`${baseUrl}shop`} class="inline-block bg-brand-red text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
          Browse Shop
        </a>
      </div>
      
      <!-- Cart Items -->
      <div id="cart-content" class="hidden">
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
          <div id="cart-items" class="divide-y">
            <!-- Items populated by JS -->
          </div>
        </div>
        
        <!-- Cart Summary -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center mb-4">
            <span class="text-gray-600">Subtotal</span>
            <span id="cart-subtotal" class="font-bold text-xl">£0.00</span>
          </div>
          <p class="text-sm text-gray-500 mb-6">Shipping calculated at checkout. Collection available in Kent/Essex area.</p>
          
          <button id="checkout-btn" class="w-full bg-brand-red text-white py-4 rounded-lg font-bold text-lg hover:bg-red-700 transition mb-3">
            Proceed to Checkout
          </button>
          
          <a href={`${baseUrl}shop`} class="block text-center text-brand-red hover:underline">
            Continue Shopping
          </a>
        </div>
        
        <!-- Clear Cart -->
        <button id="clear-cart" class="mt-4 text-gray-500 hover:text-red-600 text-sm underline">
          Clear Cart
        </button>
      </div>
      
      <!-- Checkout Modal -->
      <div id="checkout-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
          <h2 class="font-heading text-2xl font-bold mb-6">Checkout</h2>
          
          <form id="checkout-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Full Name *</label>
              <input type="text" name="name" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-red focus:border-transparent" />
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1">Email *</label>
              <input type="email" name="email" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-red focus:border-transparent" />
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1">Phone *</label>
              <input type="tel" name="phone" required pattern="[0-9\s+()-]{10,}" title="Please enter a valid UK phone number" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-red focus:border-transparent" />
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1">Delivery Method *</label>
              <select name="delivery" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-red focus:border-transparent">
                <option value="">Select...</option>
                <option value="collection">Collection (Free)</option>
                <option value="shipping">UK Shipping (+£5-15)</option>
              </select>
            </div>
            
            <div id="address-fields" class="hidden space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Address *</label>
                <input type="text" name="address" class="w-full border rounded-lg px-4 py-2" />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">City *</label>
                  <input type="text" name="city" class="w-full border rounded-lg px-4 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Postcode *</label>
                  <input type="text" name="postcode" class="w-full border rounded-lg px-4 py-2" />
                </div>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1">Notes (optional)</label>
              <textarea name="notes" rows="2" class="w-full border rounded-lg px-4 py-2"></textarea>
            </div>
            
            <div class="border-t pt-4 mt-4">
              <div class="flex justify-between mb-2">
                <span>Subtotal</span>
                <span id="modal-subtotal">£0.00</span>
              </div>
              <div class="flex justify-between mb-4">
                <span>Shipping</span>
                <span id="modal-shipping">TBC</span>
              </div>
              <div class="flex justify-between font-bold text-lg">
                <span>Total</span>
                <span id="modal-total">£0.00</span>
              </div>
            </div>
            
            <p class="text-sm text-gray-500">
              Payment instructions will be sent to your email. We accept bank transfer or cash on collection.
            </p>
            
            <div class="flex gap-3">
              <button type="button" id="cancel-checkout" class="flex-1 border border-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-50 transition">
                Cancel
              </button>
              <button type="submit" class="flex-1 bg-brand-red text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                Place Order
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Order Confirmation -->
      <div id="order-confirmation" class="hidden text-center py-12">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h2 class="font-heading text-3xl font-bold text-brand-black mb-4">Order Received!</h2>
        <p class="text-gray-600 mb-2">Thank you for supporting National Nines Golf.</p>
        <p class="text-gray-600 mb-6">We'll be in touch shortly with payment details.</p>
        <a href={`${baseUrl}shop`} class="inline-block bg-brand-red text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
          Continue Shopping
        </a>
      </div>
    </div>
  </section>
</BaseLayout>


<script>
  const emptyCart = document.getElementById('empty-cart');
  const cartContent = document.getElementById('cart-content');
  const cartItems = document.getElementById('cart-items');
  const cartSubtotal = document.getElementById('cart-subtotal');
  const checkoutBtn = document.getElementById('checkout-btn');
  const clearCartBtn = document.getElementById('clear-cart');
  const checkoutModal = document.getElementById('checkout-modal');
  const cancelCheckout = document.getElementById('cancel-checkout');
  const checkoutForm = document.getElementById('checkout-form');
  const deliverySelect = document.querySelector('select[name="delivery"]');
  const addressFields = document.getElementById('address-fields');
  const orderConfirmation = document.getElementById('order-confirmation');
  
  function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (cart.length === 0) {
      emptyCart?.classList.remove('hidden');
      cartContent?.classList.add('hidden');
      return;
    }
    
    emptyCart?.classList.add('hidden');
    cartContent?.classList.remove('hidden');
    
    let html = '';
    let total = 0;
    
    cart.forEach((item, index) => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      
      html += `
        <div class="p-4 flex items-center gap-4">
          <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="font-semibold">${item.name}</h3>
            <p class="text-brand-red font-bold">£${item.price}</p>
          </div>
          <div class="flex items-center gap-2">
            <button class="qty-btn w-8 h-8 rounded-full border flex items-center justify-center hover:bg-gray-100" data-index="${index}" data-action="decrease" aria-label="Decrease quantity">-</button>
            <span class="w-8 text-center" aria-label="Quantity">${item.quantity}</span>
            <button class="qty-btn w-8 h-8 rounded-full border flex items-center justify-center hover:bg-gray-100" data-index="${index}" data-action="increase" aria-label="Increase quantity">+</button>
          </div>
          <div class="w-20 text-right font-semibold">£${itemTotal.toFixed(2)}</div>
          <button class="remove-btn text-gray-400 hover:text-red-600" data-index="${index}" aria-label="Remove item">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      `;
    });
    
    if (cartItems) cartItems.innerHTML = html;
    if (cartSubtotal) cartSubtotal.textContent = `£${total.toFixed(2)}`;
    
    // Update modal totals
    const modalSubtotal = document.getElementById('modal-subtotal');
    const modalTotal = document.getElementById('modal-total');
    if (modalSubtotal) modalSubtotal.textContent = `£${total.toFixed(2)}`;
    if (modalTotal) modalTotal.textContent = `£${total.toFixed(2)}`;
    
    // Add event listeners
    document.querySelectorAll('.qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = parseInt(btn.dataset.index || '0');
        const action = btn.dataset.action;
        updateQuantity(index, action);
      });
    });
    
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = parseInt(btn.dataset.index || '0');
        removeItem(index);
      });
    });
  }
  
  function updateQuantity(index: number, action: string) {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if (action === 'increase') {
      cart[index].quantity++;
    } else if (action === 'decrease') {
      cart[index].quantity--;
      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    renderCart();
  }
  
  function removeItem(index: number) {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    renderCart();
  }
  
  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const cartCount = document.getElementById('cart-count');
    if (cartCount) {
      const total = cart.reduce((sum: number, i: any) => sum + i.quantity, 0);
      cartCount.textContent = total.toString();
      cartCount.classList.toggle('hidden', total === 0);
    }
  }
  
  // Clear cart
  clearCartBtn?.addEventListener('click', () => {
    if (confirm('Clear all items from your cart?')) {
      localStorage.removeItem('cart');
      updateCartCount();
      renderCart();
    }
  });
  
  // Checkout modal
  checkoutBtn?.addEventListener('click', () => {
    checkoutModal?.classList.remove('hidden');
    checkoutModal?.classList.add('flex');
  });
  
  cancelCheckout?.addEventListener('click', () => {
    checkoutModal?.classList.add('hidden');
    checkoutModal?.classList.remove('flex');
  });
  
  // Show/hide address fields based on delivery method
  deliverySelect?.addEventListener('change', () => {
    const isShipping = deliverySelect.value === 'shipping';
    addressFields?.classList.toggle('hidden', !isShipping);
    
    // Update shipping display
    const modalShipping = document.getElementById('modal-shipping');
    if (modalShipping) {
      modalShipping.textContent = isShipping ? '£5-15' : 'Free';
    }
    
    // Toggle required on address fields
    addressFields?.querySelectorAll('input').forEach(input => {
      (input as HTMLInputElement).required = isShipping;
    });
  });
  
  // Form submission
  checkoutForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Configuration: Set to true when API is ready
    const USE_API = false;
    const API_BASE = 'https://api.nationalninesgolf.co.uk';
    
    const submitBtn = checkoutForm.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    
    const formData = new FormData(checkoutForm as HTMLFormElement);
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (USE_API) {
      // API mode - sends order to backend and redirects to Stripe
      const order = {
        customerName: formData.get('name'),
        customerEmail: formData.get('email'),
        customerPhone: formData.get('phone'),
        deliveryMethod: formData.get('delivery') === 'shipping' ? 'SHIPPING' : 'COLLECTION',
        shippingAddress: formData.get('address'),
        shippingCity: formData.get('city'),
        shippingPostcode: formData.get('postcode'),
        notes: formData.get('notes'),
        items: cart.map((item: any) => ({
          productId: item.slug || item.name.toLowerCase().replace(/\s+/g, '-'),
          productName: item.name,
          quantity: item.quantity,
          unitPrice: item.price,
        })),
      };
      
      try {
        const response = await fetch(`${API_BASE}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order),
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create order');
        }
        
        const { checkoutUrl } = await response.json();
        
        // Clear cart before redirect
        localStorage.removeItem('cart');
        updateCartCount();
        
        // Redirect to Stripe Checkout
        window.location.href = checkoutUrl;
        
      } catch (error: any) {
        alert(error.message || 'Something went wrong. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    } else {
      // Fallback mode - email notification via FormSubmit
      const total = cart.reduce((sum: number, i: any) => sum + (i.price * i.quantity), 0);
      const itemsList = cart.map((i: any) => `${i.name} x${i.quantity} @ £${i.price}`).join('\n');
      
      const orderData = {
        _subject: 'New Shop Order - National Nines Golf',
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        delivery_method: formData.get('delivery'),
        address: formData.get('address') || 'N/A (Collection)',
        city: formData.get('city') || '',
        postcode: formData.get('postcode') || '',
        notes: formData.get('notes') || 'None',
        items: itemsList,
        total: `£${total.toFixed(2)}`,
        order_date: new Date().toLocaleString('en-GB'),
      };
      
      try {
        const response = await fetch('https://formsubmit.co/ajax/info@nationalninesgolf.co.uk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(orderData),
        });
        
        if (!response.ok) throw new Error('Failed to send order');
        
        // Clear cart and show confirmation
        localStorage.removeItem('cart');
        updateCartCount();
        
        checkoutModal?.classList.add('hidden');
        cartContent?.classList.add('hidden');
        emptyCart?.classList.add('hidden');
        orderConfirmation?.classList.remove('hidden');
      } catch (error) {
        alert('Failed to submit order. Please try again or contact us directly.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
  });
  
  // Check for success redirect from Stripe
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success') === 'true') {
    emptyCart?.classList.add('hidden');
    cartContent?.classList.add('hidden');
    orderConfirmation?.classList.remove('hidden');
    
    // Show order number if available
    const orderNumber = urlParams.get('order');
    if (orderNumber) {
      const orderText = orderConfirmation?.querySelector('p.text-gray-600.mb-6');
      if (orderText) {
        orderText.innerHTML = `Your order <strong>${orderNumber}</strong> has been received.<br>We'll be in touch shortly with payment details.`;
      }
    }
  }
  
  // Initialize
  renderCart();
</script>
